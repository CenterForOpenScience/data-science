---
title: "projects_multiple_OSFproducts"
output: html_document
---

This analysis is collecting initial data on the number of projects that take advantage of two of the major behaviors on the OSF that also represent different different points in the workflow: sharing files and registrations. The initial analysis does not take into account when these behaviors happen in relation to each other (e.g. are files uploaded to the project/modified after the registration or only before?), but that may be included as a more complicated relationship in later analyses. 

Data caveats and explanations:

* The data used for the analyses below goes through 4/8/19. 
* 'Sharing a file' is measured by looking for non-registered nodes that are public and have a file in them. It includes files from OSFstorage and all add-ons. If any node in a project is public and has a file in it, the top-level project is counted as sharing a file, even if the top-level itself is private. The registration does not have to be on or include the node that is sharing a file, it just has to be on a node within the same project.
* Only non-spam non-deleted projects/nodes are counted, and only non-withdrawn, non-deleted registrations are counted (excluding old private registrations). Registrations can be under embargo though and still be counted.
* Supplemental preprint nodes are include as 'projects' for this analysis.
* Linked nodes are not included in this initial analysis. So, if a project is public has no files in it, but does have a linked node that is public and has a file in it, the project would not be counted as having a public file. 

```{r warning=FALSE, echo=FALSE, message=FALSE}
#load libraries
library(tidyverse)
library(lubridate)
library(scales)
library(kableExtra)
library(osfr)
library(here)

knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```

```{r warning=FALSE, echo=FALSE, message=FALSE}
#load data, query used to generate node_data: https://github.com/CenterForOpenScience/data-science/blob/master/SQL_queries/cat_nodes_by_product.sql
osf_retrieve_file('https://osf.io/z2bcq/') %>%
  osf_download(overwrite = T)


node_data <- read_csv(here::here('Longitudinal_Research_Plan','node_categorizations.csv'))

content_logs <- read_csv('/Users/courtneysoderberg/Downloads/content_creation_logs.csv')
all_logs <- read_csv('/Users/courtneysoderberg/Downloads/logs_per_node.csv')
```

```{r warning=FALSE, echo=FALSE, message=FALSE}
sharing_and_registered <- data_projects %>%
                            group_by(root_id) %>%
                            mutate(has_file = case_when(any(number_files > 0 | addons_on_node > 0) ~ 1, TRUE ~ 0)) %>%
                            mutate(shared_file = case_when(any((number_files > 0 | addons_on_node > 0) & is_public > 0) ~ 1, TRUE ~ 0)) %>%
                            mutate(registered = case_when(any(!is.na(registration_date)) ~ 1, TRUE ~ 0)) %>%
                            summarize(has_file = max(has_file), shared_file = max(shared_file), registered = max(registered), project_created = min(node_created)) %>%
                            mutate(products = case_when(has_file > 0 & shared_file == 0 & registered == 0 ~ 'OSF_privatefiles_only',
                                                          shared_file ==1 & registered == 0 ~ 'OSF_sharingfiles_only',
                                                          shared_file == 0 & registered ==1 ~ 'Registrations_only',
                                                          shared_file == 1 & registered == 1 ~ 'OSF_sharingfiles_and_registrations',
                                                          shared_file == 0 & registered == 0 ~ 'None')) %>%
                            mutate(pc_by_day = as_date(project_created))

first_registration <- data_projects %>% group_by(root_id) %>% arrange(registration_date) %>% slice(1L) %>% select(root_id, registration_date)
first_osf_file_created <- data_projects %>% group_by(root_id) %>% arrange(first_osf_file_created) %>% slice(1L) %>% select(root_id, first_osf_file_created)
first_made_public <-  data_projects %>% group_by(root_id) %>% arrange(last_public) %>% slice(1L) %>% select(root_id, last_public)

all_dates <- sharing_and_registered %>%
                left_join(all_logs, by = 'root_id') %>%
                left_join(content_logs, by = 'root_id') %>%
                left_join(first_registration , by = 'root_id') %>%
                left_join(first_osf_file_created, by = 'root_id') %>%
                left_join(first_made_public, by = 'root_id')
```

## Initial Analyses

The table below shows the number of projects that have each of the actions. These numbers are not mutually exclusive. So, if a project shares a file and has a registration, it will count towards all three totals.

```{r echo = FALSE}
aggregate_data <- sharing_and_registered %>%
                    summarize(`Projects with no files or registrations` = sum(has_file ==0 & registered == 0),
                              `Projects with files` = sum(has_file > 0),
                              `Projects sharing > 0 files` = sum(shared_file > 0), 
                              `Projects with > 0 registrations` = sum(registered > 0),
                              `Projects sharing > 0 files and registered` = sum(shared_file > 0 & registered > 0)) %>%
                    gather() %>%
                    mutate(percentage_total_project = round((value/141313)*100,2), percentage_public_projects = ifelse(key != 'Projects with > 0 registrations' & key != 'Projects with files' & key != 'Projects with no files or registrations', round((value/56937)*100,2), NA))
                                                                                                                          
kable(aggregate_data,
  col.names = c('Project actions', 'Number of top-level projects', 'Percentage of top-level projects', 'Percentage of top-level projects with at least 1 public node')) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
  
sharing_projects <- sharing_and_registered %>% filter(shared_file == 1) %>% nrow()
registered_projects <- sharing_and_registered %>% filter(registered == 1) %>% nrow()
sharing_registered <- sharing_and_registered %>% filter(shared_file ==1 & registered ==1) %>% nrow()

```

The graph shows the number of top-level projects that were created each month that either *only* share files, *only* have a registration, do both of these things, are private and have files but no registration, or do none of these things. So, these numbers are mutually exclusive and will not exactly match the number in the table above, which are not mutually exclusive.

```{r echo = FALSE}

 graph <- ggplot(sharing_and_registered, aes(pc_by_day, color = products)) + 
  geom_freqpoly(binwidth = 30) +
  xlab('When projects were created') +
  ylab('Number of Top Level Projects') +
  scale_x_date(breaks = date_breaks("3 month"), labels = date_format("%b %y"))
 
 graph + theme(axis.text.x  = element_text(angle=45,hjust = 1,vjust = 1))
 
```

## Days from Project created to last log event:

#### Last log:

```{r echo = FALSE}

## forked projects have logs from original project as well, so will see log dates that happened before project creation date. Moving all those to 0 so only see logs that happened after fork event for forked projects

all_dates <- all_dates %>%
                  mutate(project_to_public = difftime(last_public, project_created, units = 'days'),
                         project_to_reg = difftime(registration_date, project_created, units = 'days'),
                         project_to_lastlog = difftime(last_log, project_created, units = 'days'),
                         project_to_lastcontentadd = difftime(last_contentadd_log, project_created, units = 'days')) %>%
                  mutate(project_to_lastlog = ifelse(project_to_lastlog < 0, 0, project_to_lastlog),
                         project_to_lastcontentadd = ifelse(project_to_lastcontentadd < 0, 0, project_to_lastcontentadd))

```

```{r echo=FALSE}
##time in days from project creation to the last log on the project
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)), aes(project_to_lastlog)) +
  geom_freqpoly(binwidth = 10) +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(0, 2563, by = 365),1)) +
  scale_y_continuous('Numebr of Top Level Projects', breaks = round(seq(0, 150000, by = 5000),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1),aes(project_to_lastlog)) + 
  geom_freqpoly(binwidth = 10) +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects', breaks = round(seq(0, 50000, by = 500),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1),aes(project_to_lastlog, color = products)) + 
  geom_freqpoly(binwidth = 10) +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects', breaks = round(seq(0, 50000, by = 500),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1),aes(project_to_lastlog, color = products)) + 
  geom_density() +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects')
```

#### Last content addition log

```{r echo = FALSE}
##time in days from project creation to the last log on the project
ggplot(all_dates %>% filter(!is.na(project_to_lastcontentadd)), aes(project_to_lastcontentadd)) +
  geom_freqpoly(binwidth = 10) +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(0, 2563, by = 365),1)) +
  scale_y_continuous('Numebr of Top Level Projects', breaks = round(seq(0, 150000, by = 5000),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastcontentadd)) %>% filter(project_to_lastcontentadd >= 1),aes(project_to_lastcontentadd)) + 
  geom_freqpoly(binwidth = 10) +
  ggtitle('Projects with >= 1 day between creation and last content creation log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects', breaks = round(seq(0, 50000, by = 500),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastcontentadd)) %>% filter(project_to_lastcontentadd >= 1),aes(project_to_lastcontentadd, color = products)) + 
  geom_freqpoly(binwidth = 10) +
  ggtitle('Projects with >= 1 day between creation and last content creation log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects', breaks = round(seq(0, 50000, by = 500),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastcontentadd)) %>% filter(project_to_lastcontentadd >= 1),aes(project_to_lastcontentadd, color = products)) + 
  geom_density() +
  ggtitle('Projects with >= 1 day between creation and content creation last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects')
```

```{r}
## the basefilenod table is showing incorrect creation dates for files from before

later_project <- all_dates %>%
                    filter(project_created >= '2015-05-01')


first_none <- later_project %>% filter(is.na(first_osf_file_created) & is.na(registration_date) & is.na(last_public)) # number of none projects at first level

file_first <- later_project %>% filter(!is.na(first_osf_file_created) & ((first_osf_file_created < last_public & first_osf_file_created < registration_date) | (first_osf_file_created < last_public & is.na(registration_date)) | (is.na(last_public) & first_osf_file_created < registration_date) | (is.na(last_public) & is.na(registration_date))))

public_first <- later_project %>% filter(!is.na(last_public) & ((last_public < first_osf_file_created & last_public < registration_date) | (last_public < first_osf_file_created & is.na(registration_date)) | (is.na(first_osf_file_created) & last_public < registration_date) | (is.na(first_osf_file_created) & is.na(registration_date))))
  
registered_first <- later_project %>% 
                        filter(!is.na(registration_date) & ((registration_date < last_public & registration_date < first_osf_file_created) | 
                                                              (registration_date < last_public & is.na(first_osf_file_created)) | 
                                                              (is.na(last_public) & registration_date < first_osf_file_created) | 
                                                              (is.na(last_public) & is.na(first_osf_file_created))))


file_then_reg <- file_first %>%
                    filter(!is.na(registration_date) & ((registration_date < last_public) | is.na(last_public)))
                    
file_then_public <- file_first %>%
                      filter(!is.na(last_public) & ((last_public < registration_date) | is.na(registration_date)))
file_then_none <- file_first %>% filter(is.na(last_public) & is.na(registration_date))


public_then_reg <- public_first %>%
                      filter(!is.na(registration_date) & (registration_date < first_osf_file_created | is.na(first_osf_file_created)))
public_then_file <- public_first %>%
                      filter(!is.na(first_osf_file_created) & (first_osf_file_created < registration_date | is.na(registration_date)))
public_then_nothing <- public_first %>% filter(is.na(first_osf_file_created) & is.na(registration_date))

reg_then_public <- registered_first %>%
                      filter(!is.na(last_public) & ((last_public < first_osf_file_created) | is.na(first_osf_file_created)))
reg_then_file <- registered_first %>%
                      filter(!is.na(first_osf_file_created) & ((first_osf_file_created < last_public) | is.na(last_public)))
reg_then_node <- registered_first %>% filter(is.na(last_public) & is.na(first_osf_file_created))


file_reg_public <- file_then_reg %>% filter(!is.na(last_public))
file_reg_none <- file_then_reg %>% filter(is.na(last_public))

file_public_reg <- file_then_public %>% filter(!is.na(registration_date))
file_public_none <- file_then_public %>% filter(is.na(registration_date))


public_reg_file <- public_then_reg %>% filter(!is.na(first_osf_file_created))
public_reg_none <- public_then_reg %>% filter(is.na(first_osf_file_created))

public_file_reg <- public_then_file %>% filter(!is.na(registration_date))
public_file_none <- public_then_file %>% filter(is.na(registration_date))

reg_public_file <- reg_then_public %>% filter(!is.na(first_osf_file_created))
reg_public_none <- reg_then_public %>% filter(is.na(first_osf_file_created))

reg_file_public <- reg_then_file %>% filter(!is.na(last_public))
reg_file_none <- reg_then_file %>% filter(is.na(last_public))

```



```

Potential Next Steps for more complex relationships:

* Are files that are eventually shared being added/modified before or after registrations?
* Add linked projects to the analyses
* How many of the 4817 projects that share files and are registered have contributors in common (i.e. are these projects by a diverse group of people or a smaller set of users who doing this repeatedly across projects)?
* What are the projects with no files in them doing? A lot of them will be empty preprint supplemental nodes, the majority left over from NPD but many newly created supplemental nodes are also left empty. But, not all of them will be supplemental nodes, so what *is* in those projects?
