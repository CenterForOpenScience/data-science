---
title: "Workflows of Projects on the OSF"
output: html_document
---

This analysis is collecting initial data on the number of projects that take advantage of two of the major behaviors on the OSF that also represent different different points in the workflow: sharing files and registrations.

General Data caveats and explanations:

* The data used for the analyses includes projects created on or before 9/1/19 and logs through 10/04/19. 
* Only non-spam non-deleted projects/nodes are counted.
* Supplemental nodes that were created pre-NPD and are empty (no files, no addons, no links, no components, and no wiki_update or registration logs) were removed from the analysis.
* Only non-withdrawn, non-deleted registrations are counted (excluding old private registrations). Registrations can be under embargo though and still be counted.
* Linked nodes are not included in this initial analysis. So, if a project is public has no files in it, but does have a linked node that is public and has a file in it, the project would not be counted as having a public file. 

\

```{r warning=FALSE, echo=FALSE, message=FALSE}
#load libraries
library(tidyverse)
library(lubridate)
library(scales)
library(kableExtra)
library(osfr)
library(here)
library(ggalluvial)
library(plotly)
library(UpSetR)

knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```

```{r warning=FALSE, echo=FALSE, message=FALSE, results = 'hide'}
#load data, query used to generate node_data: https://github.com/CenterForOpenScience/data-science/blob/master/SQL_queries/cat_nodes_by_product.sql
osf_retrieve_file('https://osf.io/z2bcq/') %>%
  osf_download(overwrite = T)



node_data <- read_csv(
                here::here('Longitudinal_Research_Plan','node_categorizations.csv'), 
                col_types = cols(
                  deleted_date = col_datetime(),
                  registered_date = col_datetime(),
                  embargo_id = col_double(),
                  registered_from_id = col_double(),
                  retraction_id = col_double(),
                  suppnode_date_added = col_datetime(),
                  bitbucket_added = col_datetime(),
                  figshare_added = col_datetime(),
                  gitlab_added = col_datetime(),
                  onedrive_added = col_datetime(),
                  owncloud_added = col_datetime(),
                  registered = col_logical()
                ))

```
```{r warning=FALSE, echo=FALSE, message=FALSE}
osf_retrieve_file('https://osf.io/y29as/') %>%
  osf_download(overwrite = T)

content_logs <- c("addon_file_copied", "addon_file_moved", "addon_removed", "bitbucket_repo_linked", "bitbucker_node_deauthorized", "box_file_added", "box_file_updated", "box_file_removed", "box_folder_selected", "box_node_deauthorized", "dataverse_dataset_linked", "dataverse_dataset_published", "dataverse_file_added", "dataverse_file_removed", "dataverse_file_updated", "dataverse_node_deauthorized", "dataverse_study_linked", "dataverse_study_released", "dropbox_file_added", "dropbox_file_removed", "dropbox_file_updated", "dropbox_folder_selected", "dropbox_node_deauthorized", "figshare_content_unlinked", "figshare_file_added", "figshare_file_removed", "figshare_folder_selected", "figshare_node_deauthorized", "file_added", "file_removed", "file_updated", "github_file_added", "github_file_removed", "github_file_updated", "github_node_deauthorized", "github_repo_linked", "github_repo_unlinked", "gitlab_node_deauthorized", "gitlab_repo_linked", "googledrive_file_added", "googledrive_file_removed", "googledrive_file_updated", "googledrive_folder_selected", "googledrive_node_deauthorized", "made_public", "made_private", "mendeley_folder_selected", "mendeley_node_deauthorized", "onedrive_folder_selected", "onedrive_node_deauthorized", "osf_storage_file_added", "osf_storage_file_removed", "osf_storage_file_updated", "owncloud_file_added", "owncloud_file_removed", "owncloud_file_updated", "owncloud_folder_created", "owncloud_node_deauthorized", "owncloud_folder_selected", "project_deleted", "project_created", "node_removed", "prereg_registration_initiated", "project_registered", "registration_cancelled", "retraction_initiated", "retraction_approved", "retraction_canceled", "s3_bucket_linked", "s3_bucket_unlinked", "s3_file_added", "s3_file_removed", "s3_file_updated", "s3_node_deauthorized", "wiki_updated", "zotero_folder_selected", "zotero_library_selected", "zotero_node_deauthorized", "addon_added", "node_created", "node_forked", "pointer_created", "pointer_removed")


project_logs <- read_csv(here::here('Longitudinal_Research_Plan','project_logs.csv')) %>%
                    filter(root_id != id | (root_id == id & action != 'project_created')) %>%
                    mutate(log_type = case_when(grepl(paste(content_logs,collapse="|"),action) ~ 'content', 
                                                   TRUE ~ 'metadata' )) %>%
                    group_by(root_id, log_type) %>%
                    summarize(first_log = min(first_date), last_log = max(last_date))
```


```{r warning=FALSE, echo=FALSE, message=FALSE}
projects_by_product <- node_data %>%
                            filter(type == 'osf.node' & is_deleted == FALSE) %>%
                            group_by(root_id) %>%
                            mutate(registered = case_when(any(registered == TRUE) ~ 1, all(registered == FALSE) ~ 0),
                                   is_fork = case_when(any(is_fork == TRUE) ~ 1),
                                   is_public = case_when(any(is_public == TRUE) ~ 1, all(is_public == FALSE) ~ 0)) %>%
                            summarize(nodes_in_project = n(),
                                      has_file = max(has_files), 
                                      is_fork = max(is_fork),
                                      shared_file = max(public_sharing), 
                                      registered = max(registered),
                                      is_public = max(is_public),
                                      project_created = min(created),
                                      osf4m = max(osf4m),
                                      wiki_updates = sum(num_wiki_edits, na.rm = T),
                                      link_created = sum(num_links_added, na.rm = T),
                                      links_removed = sum(num_links_removed, na.rm = T),
                                      movecopy_actions = sum(num_copy_moves, na.rm = T),
                                      suppnode = max(preprint_suppnode),
                                      first_reg = if(all(is.na(first_reg))) NA else min(first_reg, na.rm = TRUE),
                                      first_file = if(all(is.na(first_file))) NA else min(first_file, na.rm = TRUE),
                                      first_public = if(all(is.na(date_made_public))) NA else min(date_made_public, na.rm = TRUE),
                                      first_reg = as_datetime(first_reg)) %>%
                            filter(project_created <= '2019-09-01') %>%
                            mutate(products = case_when(has_file > 0 & shared_file == 0 & registered == 0 ~ 'Files_Private',
                                                          shared_file ==1 & registered == 0 ~ 'Files_Public',
                                                          shared_file == 0 & registered ==1 & is_public == 0 ~ 'Reg_Private',
                                                          shared_file == 1 & registered == 1 ~ 'Files_Reg_Public',
                                                          shared_file == 0 & registered == 0 & has_file == 0 & is_public == 0 ~ 'Empty_Private')) %>%
                            mutate(days_create_public = difftime(first_public, project_created, units = 'days'),
                                   days_create_reg = difftime(first_reg, project_created, units = 'days'),
                                   days_create_files = difftime(first_file, project_created, units = 'days'),
                                   days_reg_pub = difftime(first_public, first_reg, units = 'days'),
                                   days_reg_files = difftime(first_file, first_reg, units = 'days'),
                                   days_public_reg = difftime(first_reg, first_public, units = 'days'),
                                   days_public_files = difftime(first_file, first_public, units = 'days'),
                                   days_files_reg = difftime(first_reg, first_file, units = 'days'),
                                   days_files_public = difftime(first_public, first_file, units = 'days')) %>%
                            mutate(pc_by_day = as_date(project_created))  %>%
                                                      mutate(year = year(project_created))


projects_and_logs <- projects_by_product %>%
                left_join(project_logs, by = 'root_id') %>%
                mutate(days_create_lastlog = difftime(last_log, project_created, units = 'days'))
```

## How many multiple action projects are there?

The graph below shows the number of non-deleted projects that have each action (horizontal bars on the bottom left) and the intersections of those actions (vertical bars). The lines and dots show what intersection of actions each vertical bar is tallying. There are `r nrow(projects_by_product)` total non-deleted projects. 

\

```{r warning=FALSE, echo=FALSE, message=FALSE}
intersections <- projects_by_product %>% 
  select(root_id, has_file, shared_file, registered, is_public) %>%
  mutate(no_action = case_when(has_file == 0 & shared_file == 0 & registered == 0  ~ 1,
                      has_file == 1 | shared_file == 1 | registered == 1  ~ 0)) %>%
  select(has_file, registered, is_public, shared_file, no_action) %>%
  rename(`Has a file` = has_file,
         `>= 1 public node` = is_public,
         `Been registered` = registered,
         `File in a public node` = shared_file,
         `Empty project` = no_action) %>%
  as.data.frame()

upset(intersections, 
      sets = c('Been registered', 'File in a public node', '>= 1 public node', 'Has a file', 'Empty project'), 
      main.bar.color = "SteelBlue", 
      sets.bar.color = "DarkCyan", 
      sets.x.label = "Top-Level Projects Count", 
      text.scale = c(rep(1.4, 5), 2), 
      keep.order = T,
      set_size.show = T, 
      set_size.scale_max = 125000)
```

\

#### When were these different 'types' of project created?

The graph below shows timecourse of when these projects were created. I only retained a subsect of the 12 potential intersections in the graph for clarity. 

\

```{r warning=FALSE, echo=FALSE, message=FALSE}
ggplotly(projects_by_product %>%
  filter(!is.na(products)) %>%
  ggplot(aes(pc_by_day, color = products)) + 
  geom_freqpoly(binwidth = 30) +
  xlab('When projects were created') +
  ylab('Number of Top Level Projects') +
  scale_x_date(breaks = date_breaks("3 month"), labels = date_format("%b %y")) +
  theme(axis.text.x  = element_text(angle=45,hjust = 1,vjust = 1)))
 
```

## How long are different projects 'active' for?:

The graphs be show the time, in days, between a projects creation and the last log on the project. Graphs are facited by the `type` of log:

* `Content` logs are any logs that involve the addition, updating, or removal of files, add-ons, wikis, or structural elements, as well as changes to public/private settings. 
* `Metadata` logs are any that make alterations to to things like titles, descriptions, tags, or contributors.

*Caveats*
* Forked projects are not included, because they include their origin projects logs so they can have negative times.


#### Last log:

```{r warning=FALSE, echo=FALSE, message=FALSE}

log_time_stats <- projects_and_logs %>% 
  filter(is.na(is_fork) & !is.na(days_create_lastlog)) %>% 
  group_by(log_type) %>% 
  summarize(Mean = mean(days_create_lastlog), Median = median(days_create_lastlog))

##time in days from project creation to the last log on the project
ggplot(projects_and_logs %>% filter(is.na(is_fork)) %>% filter(!is.na(days_create_lastlog)), aes(days_create_lastlog)) +
  geom_freqpoly(binwidth = 25) +
  facet_wrap(~log_type) +
  geom_vline(data = log_time_stats, aes(xintercept = Mean), color = 'red') + 
  geom_vline(data = log_time_stats, aes(xintercept = Median), color = 'blue') + 
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 1840, by = 180),1)) +
  scale_y_log10('Numebr of Top Level Projects')

##time in days from project creation to the last log on the project by product type
ggplot(projects_and_logs %>% filter(is.na(is_fork) & !is.na(days_create_lastlog) & !is.na(products)),aes(days_create_lastlog, color = products)) + 
  geom_freqpoly(binwidth = 25) +
  facet_wrap(~log_type) +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 1840, by = 180),1)) +
  scale_y_log10('Numebr of Top Level Projects')

##time in days from project creation to the last log on the project by product type, faceted by year
ggplot(projects_and_logs %>% filter(is.na(is_fork) & !is.na(days_create_lastlog) & !is.na(products) & (year != '2012' & year != '2013' & year != '2014')),aes(days_create_lastlog, color = products)) + 
  geom_freqpoly(binwidth = 25) +
  facet_grid(year ~ log_type) +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 1840, by = 180),1)) +
  scale_y_log10('Number of Top Level Projects')
```


## What's the flow of events within projects?

#### Caveats

* Forks and any projects that have file copied or file moved actions are removed for this analysis, because the file creation dates (in the case of moves/copies) and the log dates (in the case of forks) aren't accurate
* Only projects created *after* 5/1/15 are included in these analyses, b/c the date stamps on files aren't accurate before that
* A total of `r nrow(projects_by_product %>% filter(movecopy_actions == 0 & is.na(is_fork) & project_created > '2015-05-01') %>% filter(osf4m == 1))` osf4m projects are included in the flow diagram below. The vast majority of these fall into the `Created Project -> Made Public -> Upload File -> None` flow path. 

\
\

```{r warning=FALSE, echo=FALSE, message=FALSE}

action_flow <- projects_by_product %>%
                        filter(movecopy_actions == 0) %>%
                        filter(is.na(is_fork)) %>%
                        filter(project_created > '2015-05-01') %>%   #file creation dates only accurate after May 1st, 2015
                        mutate(action1 = 'Created Project',
                               action2 = case_when(is.na(first_file) & is.na(first_public) & is.na(first_reg) ~ 'None',
                                                   (first_file < first_public | (is.na(first_public) & !is.na(first_file))) &
                                                      (first_file < first_reg | (is.na(first_reg) & !is.na(first_file))) ~ 'Upload File',
                                                   (first_public < first_file | (is.na(first_file) & !is.na(first_public))) & 
                                                      (first_public < first_reg | (is.na(first_reg) & !is.na(first_public))) ~ 'Made Public',
                                                   (first_reg < first_public | (is.na(first_public) & !is.na(first_reg))) & 
                                                      (first_reg < first_file | (is.na(first_file) & !is.na(first_reg))) ~ 'Registered'),
                               action3 = case_when(action2 == 'Upload File' & is.na(first_public) & is.na(first_reg) ~ 'None',
                                                   action2 == 'Upload File' & (first_public < first_reg | is.na(first_reg)) ~ 'Made Public',
                                                   action2 == 'Upload File' & (first_reg < first_public | is.na(first_public)) ~ 'Registered',
                                                   action2 == 'Made Public' & is.na(first_file) & is.na(first_reg) ~ 'None',
                                                   action2 == 'Made Public' & (first_file < first_reg | is.na(first_reg)) ~ 'Upload File',
                                                   action2 == 'Made Public' & (first_reg < first_file | is.na(first_file)) ~ 'Registered',
                                                   action2 == 'Registered' & is.na(first_file) & is.na(first_public) ~ 'None',
                                                   action2 == 'Registered' & (first_file < first_public | is.na(first_public)) ~ 'Upload File',
                                                   action2 == 'Registered' & (first_public < first_file | is.na(first_file)) ~ 'Made Public',
                                                   action2 == 'None' ~ 'None'),
                               action4 = case_when(action2 == 'Upload File' & action3 == 'Made Public' & is.na(first_reg) ~ 'None',
                                                   action2 == 'Upload File' & action3 == 'Made Public' & !is.na(first_reg) ~ 'Registered',
                                                   action2 == 'Upload File' & action3 == 'Registered' & is.na(first_public) ~ 'None',
                                                   action2 == 'Upload File' & action3 == 'Registered' & !is.na(first_public) ~ 'Made Public',
                                                   action2 == 'Made Public' & action3 == 'Upload File' & is.na(first_reg) ~ 'None',
                                                   action2 == 'Made Public' & action3 == 'Upload File' & !is.na(first_reg) ~ 'Registered',
                                                   action2 == 'Made Public' & action3 == 'Registered' & is.na(first_file) ~ 'None',
                                                   action2 == 'Made Public' & action3 == 'Registered' & !is.na(first_file) ~ 'Upload File',
                                                   action2 == 'Registered' & action3 == 'Upload File' & is.na(first_public) ~ 'None',
                                                   action2 == 'Registered' & action3 == 'Upload File' & !is.na(first_public) ~ 'Made Public',
                                                   action2 == 'Registered' & action3 == 'Made Public' & is.na(first_file) ~ 'None',
                                                   action2 == 'Registered' & action3 == 'Made Public' & !is.na(first_file) ~ 'Upload File',
                                                   action3 == 'None' ~ 'None')) %>%
                                  select(action1, action2, action3, action4) %>%
                                  group_by(action1, action2, action3, action4) %>%
                                  tally()

source <- c(0, 0, 0, 0, 3, 3, 3, 2, 2, 2, 4, 4, 4, 7, 7, 7, 6, 6, 6, 8, 8, 8)
target <- c(3, 1, 2, 4, 5, 6, 8, 7, 5, 8, 7, 5, 6, 9, 10, 12, 11, 9, 12, 11, 9, 10)

sankey_data <- rbind(action_flow %>% group_by(action1, action2) %>% summarize(total = sum(n)) %>% rename(from = action1, to = action2),
                      action_flow %>% group_by(action2, action3) %>% summarize(total = sum(n)) %>% rename(from = action2, to = action3),
                      action_flow %>% group_by(action3, action4) %>% summarize(total = sum(n)) %>% rename(from = action3, to = action4)) %>%
              filter(from != 'None') %>%
              add_column(source, target)

p <- plot_ly(
  type = 'sankey',
  orientation = 'h',
  
  node = list(
    label = c("Created Project", "None", "Registered", "Made Public", "Upload File", 'None', "Registered", 'Made Public', "Upload File", "None", "Registered", "Made Public", "Upload File"),
    color = c("blue", "black", "blue", "blue", "blue", "black", "red", "red", "red", "black", "green", "green", "green"),
    pad = 15,
    thickness = 20,
    line = list(
      color = 'black',
      width = .5
    )
  ),
  
  link = list(
    source = sankey_data$source,
    target = sankey_data$target,
    value = sankey_data$total
  )
) %>%
  layout(
    title = 'Non-Deleted, Non-registrations Project Event Flow',
    font = list(
      size = 10
    )
  )
 p
```


### Workflow Investigations:

#### Can wikis or links explain the strange 'None' behavior?

* Percentage of `Created -> None` projects with wiki updates or linked nodes: `r round(100*nrow(projects_by_product %>% filter(movecopy_actions == 0 & is.na(is_fork) & project_created > '2015-05-01' & is.na(first_file) & is.na(first_public) & is.na(first_reg)& (wiki_updates > 0 | link_created > 0)))/nrow(projects_by_product %>% filter(movecopy_actions == 0 & is.na(is_fork) & project_created > '2015-05-01' & is.na(first_file) & is.na(first_public) & is.na(first_reg))),2)`
* Percentage of `Created -> Made Public -> None` projects with wiki updates or linked nodes: `r round(100*nrow(projects_by_product %>% filter(movecopy_actions == 0 & is.na(is_fork) & project_created > '2015-05-01' & is.na(first_file) & !is.na(first_public) & is.na(first_reg)& (wiki_updates > 0 | link_created > 0)))/nrow(projects_by_product %>% filter(movecopy_actions == 0 & is.na(is_fork) & project_created > '2015-05-01' & is.na(first_file) & !is.na(first_public) & is.na(first_reg))),2)`


### Median Time between Steps

The graph below is the same sankey diagram as above, but this time it's plotting median time (in days) rather than counts of projects. For this analysis, I removed projects that were OSF4M projects, since the actions are done automatically by the system, rather than by explicit user actions.

\

```{r warning=FALSE, echo=FALSE, message=FALSE}

project_timeline <- projects_by_product %>%
  filter(movecopy_actions == 0) %>%
  filter(is.na(is_fork)) %>%
  filter(project_created > '2015-05-01') %>%
  filter(osf4m == 0 | (nodes_in_project > 1 & osf4m == 1)) %>%
  mutate(action1 = 'Created Project',
         action2 = case_when(is.na(first_file) & is.na(first_public) & is.na(first_reg) ~ 'None',
                             (first_file < first_public | (is.na(first_public) & !is.na(first_file))) &
                                (first_file < first_reg | (is.na(first_reg) & !is.na(first_file))) ~ 'Upload File',
                             (first_public < first_file | (is.na(first_file) & !is.na(first_public))) & 
                                (first_public < first_reg | (is.na(first_reg) & !is.na(first_public))) ~ 'Made Public',
                             (first_reg < first_public | (is.na(first_public) & !is.na(first_reg))) & 
                                (first_reg < first_file | (is.na(first_file) & !is.na(first_reg))) ~ 'Registered'),
         action3 = case_when(action2 == 'Upload File' & is.na(first_public) & is.na(first_reg) ~ 'None',
                             action2 == 'Upload File' & (first_public < first_reg | is.na(first_reg)) ~ 'Made Public',
                             action2 == 'Upload File' & (first_reg < first_public | is.na(first_public)) ~ 'Registered',
                             action2 == 'Made Public' & is.na(first_file) & is.na(first_reg) ~ 'None',
                             action2 == 'Made Public' & (first_file < first_reg | is.na(first_reg)) ~ 'Upload File',
                             action2 == 'Made Public' & (first_reg < first_file | is.na(first_file)) ~ 'Registered',
                             action2 == 'Registered' & is.na(first_file) & is.na(first_public) ~ 'None',
                             action2 == 'Registered' & (first_file < first_public | is.na(first_public)) ~ 'Upload File',
                             action2 == 'Registered' & (first_public < first_file | is.na(first_file)) ~ 'Made Public',
                             action2 == 'None' ~ 'None'),
         action4 = case_when(action2 == 'Upload File' & action3 == 'Made Public' & is.na(first_reg) ~ 'None',
                             action2 == 'Upload File' & action3 == 'Made Public' & !is.na(first_reg) ~ 'Registered',
                             action2 == 'Upload File' & action3 == 'Registered' & is.na(first_public) ~ 'None',
                             action2 == 'Upload File' & action3 == 'Registered' & !is.na(first_public) ~ 'Made Public',
                             action2 == 'Made Public' & action3 == 'Upload File' & is.na(first_reg) ~ 'None',
                             action2 == 'Made Public' & action3 == 'Upload File' & !is.na(first_reg) ~ 'Registered',
                             action2 == 'Made Public' & action3 == 'Registered' & is.na(first_file) ~ 'None',
                             action2 == 'Made Public' & action3 == 'Registered' & !is.na(first_file) ~ 'Upload File',
                             action2 == 'Registered' & action3 == 'Upload File' & is.na(first_public) ~ 'None',
                             action2 == 'Registered' & action3 == 'Upload File' & !is.na(first_public) ~ 'Made Public',
                             action2 == 'Registered' & action3 == 'Made Public' & is.na(first_file) ~ 'None',
                             action2 == 'Registered' & action3 == 'Made Public' & !is.na(first_file) ~ 'Upload File',
                             action3 == 'None' ~ 'None')) %>%
  mutate(time_action2 = case_when(action2 == 'Made Public' ~ days_create_public,
                                  action2 == 'Registered' ~ days_create_reg,
                                  action2 == 'Upload File' ~ days_create_files),
         time_action3 = case_when(action2 == 'Made Public' & action3 == 'Registered' ~ days_public_reg,
                                  action2 == 'Made Public' & action3 == 'Upload File' ~ days_public_files,
                                  action2 == 'Registered' & action3 == 'Upload File' ~ days_reg_files,
                                  action2 == 'Registered' & action3 == 'Made Public' ~ days_reg_pub,
                                  action2 == 'Upload File' & action3 == 'Registered' ~ days_files_reg,
                                  action2 == 'Upload File' & action3 == 'Made Public' ~ days_files_public),
         time_action4 = case_when(action3 == 'Made Public' & action4 == 'Upload File' ~ days_public_files,
                                  action3 == 'Made Public' & action4 == 'Registered' ~ days_public_reg,
                                  action3 == 'Registered' & action4 == 'Upload File' ~ days_reg_files,
                                  action3 == 'Registered' & action4 == 'Made Public' ~ days_reg_pub,
                                  action3 == 'Upload File' & action4 == 'Registered' ~ days_files_reg,
                                  action3 == 'Upload File' & action4 == 'Made Public' ~ days_files_public),
         total_time = case_when(action3 == 'None' & action2 == 'Registered' ~ days_create_reg,
                                action3 == 'None' & action2 == 'Made Public' ~ days_create_public,
                                action3 == 'None' & action2 == 'Upload File' ~ days_create_files,
                                action4 == 'None' & action3 == 'Registered'~ days_create_reg,
                                action4 == 'None' & action3 == 'Made Public' ~ days_create_public,
                                action4 == 'None' & action3 == 'Upload File' ~ days_create_files,
                                action4 == 'Made Public' ~ days_create_public,
                                action4 == 'Registered' ~ days_create_reg,
                                action4 == 'Upload File' ~ days_create_files))

sankey_time_data <- rbind(project_timeline %>% group_by(action1, action2) %>% summarize(median = median(time_action2, na.rm = T)) %>% rename(from = action1, to = action2) %>% mutate(median = as.numeric(median)),
                      project_timeline %>% group_by(action2, action3) %>% summarize(median = median(time_action3, na.rm = T)) %>% rename(from = action2, to = action3) %>% mutate(median = as.numeric(median)),
                      project_timeline %>% group_by(action3, action4) %>% summarize(median = median(time_action4, na.rm = T)) %>% rename(from = action3, to = action4) %>% mutate(median = as.numeric(median))) %>%
              filter(from != 'None') %>%
              add_column(source, target) %>%
              mutate(median = case_when(!is.na(median) ~ median,
                                        is.na(median) ~ 0))


tp <- plot_ly(
  type = 'sankey',
  orientation = 'h',
  
  node = list(
    label = c("Created Project", "None", "Registered", "Made Public", "Upload File", 'None', "Registered", 'Made Public', "Upload File", "None", "Registered", "Made Public", "Upload File"),
    color = c("blue", "black", "blue", "blue", "blue", "black", "red", "red", "red", "black", "green", "green", "green"),
    pad = 15,
    thickness = 20,
    line = list(
      color = 'black',
      width = .5
    )
  ),
  
  link = list(
    source = sankey_time_data$source,
    target = sankey_time_data$target,
    value = sankey_time_data$median
  )
) %>%
  layout(
    title = 'Non-Deleted, Non-registrations Project Event Flow Times (in median days)',
    font = list(
      size = 10
    )
  )
 tp


time_estimates <- project_timeline %>% 
                        group_by(action1, action2, action3, action4) %>% 
                        summarize(avg_til2 = round(mean(time_action2),2),
                                  sd_til2 = round(sd(time_action2),2),
                                  median_til2 = round(median(time_action2),2),
                                  avg_til3 = round(mean(time_action3),2),
                                  sd_til3 = round(sd(time_action3),2),
                                  median_til3 = round(median(time_action3),2),
                                  avg_til4 = round(mean(time_action4),2),
                                  sd_til4 = round(sd(time_action4),2),
                                  median_til4 = round(median(time_action4),2),
                                  avg_overtime = round(mean(total_time),2),
                                  sd_overtime = round(sd(total_time),2),
                                  median_overtime = round(median(total_time),2))

```

\

To get an idea of the spread in times, the graphs below are histograms of the time between actions.

```{r warning=FALSE, echo=FALSE, message=FALSE}

action2_stats <- project_timeline %>% 
                    filter(time_action2 > 0) %>%
                    group_by(action2) %>%
                    summarize(Mean = mean(time_action2), Median = median(time_action2))
action3_stats <- project_timeline %>% 
                    filter(time_action2 > 0 & action3 > 0) %>%
                    group_by(action2, action3) %>%
                    summarize(Mean = mean(time_action2), Median = median(time_action2))

ggplot(project_timeline %>% filter(time_action2 > 0), aes(time_action2)) +
  geom_histogram(binwidth = 25) +
  facet_wrap(~action2) +
  geom_vline(data = action2_stats, aes(xintercept = Mean), color = 'red') + 
  geom_vline(data = action2_stats, aes(xintercept = Median), color = 'blue') + 
  scale_x_continuous('Days Elapsed',
                     breaks = round(seq(0, 1460, by = 180),1)) +
  scale_y_log10('Number of Top Level Projects') +
  ggtitle('Time between project creation and first action')
  

ggplot(project_timeline %>% filter(time_action3 > 0), aes(time_action3)) +
  facet_grid(action3~action2) +
  geom_histogram(binwidth = 25) +
    geom_vline(data = action3_stats, aes(xintercept = Mean), color = 'red') + 
  geom_vline(data = action3_stats, aes(xintercept = Median), color = 'blue') + 
  scale_x_continuous('Days Elapsed',
                     breaks = round(seq(0, 1460, by = 180),1)) +
  scale_y_log10('Number of Top Level Projects') +
  ggtitle('Time between 1st action [on x-axis] and 2nd action [on y-axis]')
```

```

Potential Next Steps for more complex relationships:

* How many of the 4817 projects that share files and are registered have contributors in common (i.e. are these projects by a diverse group of people or a smaller set of users who doing this repeatedly across projects)?
* What disciplines are the different types of projects from? (Can't get this directly until discipline is added to profiles, but migth be able to back-guess for projects with contributors who have uploaded preprints)
* What are the projects with no files in them doing?
