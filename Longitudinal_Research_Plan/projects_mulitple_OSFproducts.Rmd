---
title: "projects_multiple_OSFproducts"
output: html_document
---

This analysis is collecting initial data on the number of projects that take advantage of two of the major behaviors on the OSF that also represent different different points in the workflow: sharing files and registrations.

Data caveats and explanations:

* The data used for the analyses below goes through 6/27/19. 
* Only non-spam non-deleted projects/nodes are counted. Supplemental nodes that were created pre-NPD and are empty (no files, no addons, no links, no components, and no wiki_update or registration logs) were removed from the analysis.
* 'Sharing a file' is measured by looking for non-registered nodes that are public and have an OSFstorage file in them or an add-on folder/repo attached. If any node in a project is public and has a file in it, the top-level project is counted as sharing a file, even if the top-level itself is private. 
* Only non-withdrawn, non-deleted registrations are counted (excluding old private registrations). Registrations can be under embargo though and still be counted.
* For a project to be labeled `Sharing a file` and `Registered`, the sharing and registration do not have to include the same nodes, just some node within a project must be sharing a file and either the same or a different node must be registered.
* Linked nodes are not included in this initial analysis. So, if a project is public has no files in it, but does have a linked node that is public and has a file in it, the project would not be counted as having a public file. 

```{r warning=FALSE, echo=FALSE, message=FALSE}
#load libraries
library(tidyverse)
library(lubridate)
library(scales)
library(kableExtra)
library(osfr)
library(here)
library(ggalluvial)

knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```

```{r warning=FALSE, echo=FALSE, message=FALSE}
#load data, query used to generate node_data: https://github.com/CenterForOpenScience/data-science/blob/master/SQL_queries/cat_nodes_by_product.sql
osf_retrieve_file('https://osf.io/z2bcq/') %>%
  osf_download(overwrite = T)


node_data <- read_csv(
                here::here('Longitudinal_Research_Plan','node_categorizations.csv'), 
                col_types = cols(
                  deleted_date = col_datetime(),
                  registered_date = col_datetime(),
                  embargo_id = col_double(),
                  registered_from_id = col_double(),
                  retraction_id = col_double(),
                  suppnode_date_added = col_datetime(),
                  bitbucket_added = col_datetime(),
                  figshare_added = col_datetime(),
                  gitlab_added = col_datetime(),
                  onedrive_added = col_datetime(),
                  owncloud_added = col_datetime(),
                  registered = col_logical()
                ))

content_logs <- read_csv('/Users/courtneysoderberg/Downloads/content_creation_logs.csv')
all_logs <- read_csv('/Users/courtneysoderberg/Downloads/logs_per_node.csv')
```

```{r warning=FALSE, echo=FALSE, message=FALSE}
projects_by_product <- node_data %>%
                            filter(type == 'osf.node' & is_deleted == FALSE) %>%
                            group_by(root_id) %>%
                            mutate(registered = case_when(any(registered == TRUE) ~ 1, all(registered == FALSE) ~ 0)) %>%
                            summarize(has_file = max(has_files), 
                                      shared_file = max(public_sharing), 
                                      registered = max(registered), 
                                      project_created = min(created),
                                      osf4m = max(osf4m),
                                      suppnode = max(preprint_suppnode),
                                      first_reg = if(all(is.na(first_reg))) NA else min(first_reg, na.rm = TRUE),
                                      first_file = if(all(is.na(first_file))) NA else min(first_file, na.rm = TRUE),
                                      first_public = if(all(is.na(date_made_public))) NA else min(date_made_public, na.rm = TRUE)) %>%
                            mutate(products = case_when(has_file > 0 & shared_file == 0 & registered == 0 ~ 'OSF_privatefiles_only',
                                                          shared_file ==1 & registered == 0 ~ 'OSF_sharingfiles_only',
                                                          shared_file == 0 & registered ==1 ~ 'Registrations_only',
                                                          shared_file == 1 & registered == 1 ~ 'OSF_sharingfiles_and_registrations',
                                                          shared_file == 0 & registered == 0 & has_file == 0 ~ 'None')) %>%
                            mutate(pc_by_day = as_date(project_created))  %>%
                            mutate(year = year(project_created))

all_dates <- projects_by_product %>%
                left_join(all_logs, by = 'root_id') %>%
                left_join(content_logs, by = 'root_id')
```

```{r}
library(plotly) 

action_flow <- projects_by_product %>%
                        mutate(action1 = 'Created Project',
                               action2 = case_when(is.na(first_file) & is.na(first_public) & is.na(first_reg) ~ 'None',
                                                   (first_file < first_public | (is.na(first_public) & !is.na(first_file))) &
                                                      (first_file < first_reg | (is.na(first_reg) & !is.na(first_file))) ~ 'Upload File',
                                                   (first_public < first_file | (is.na(first_file) & !is.na(first_public))) & 
                                                      (first_public < first_reg | (is.na(first_reg) & !is.na(first_public))) ~ 'Made Public',
                                                   (first_reg < first_public | (is.na(first_public) & !is.na(first_reg))) & 
                                                      (first_reg < first_file | (is.na(first_file) & !is.na(first_reg))) ~ 'Registered'),
                               action3 = case_when(action2 == 'Upload File' & is.na(first_public) & is.na(first_reg) ~ 'None',
                                                   action2 == 'Upload File' & (first_public < first_reg | is.na(first_reg)) ~ 'Made Public',
                                                   action2 == 'Upload File' & (first_reg < first_public | is.na(first_public)) ~ 'Registered',
                                                   action2 == 'Made Public' & is.na(first_file) & is.na(first_reg) ~ 'None',
                                                   action2 == 'Made Public' & (first_file < first_reg | is.na(first_reg)) ~ 'Upload File',
                                                   action2 == 'Made Public' & (first_reg < first_file | is.na(first_file)) ~ 'Registered',
                                                   action2 == 'Registered' & is.na(first_file) & is.na(first_public) ~ 'None',
                                                   action2 == 'Registered' & (first_file < first_public | is.na(first_public)) ~ 'Upload File',
                                                   action2 == 'Registered' & (first_public < first_file | is.na(first_file)) ~ 'Made Public',
                                                   action2 == 'None' ~ 'None'),
                               action4 = case_when(action2 == 'Upload File' & action3 == 'Made Public' & is.na(first_reg) ~ 'None',
                                                   action2 == 'Upload File' & action3 == 'Made Public' & !is.na(first_reg) ~ 'Registered',
                                                   action2 == 'Upload File' & action3 == 'Registered' & is.na(first_public) ~ 'None',
                                                   action2 == 'Upload File' & action3 == 'Registered' & !is.na(first_public) ~ 'Made Public',
                                                   action2 == 'Made Public' & action3 == 'Upload File' & is.na(first_reg) ~ 'None',
                                                   action2 == 'Made Public' & action3 == 'Upload File' & !is.na(first_reg) ~ 'Registered',
                                                   action2 == 'Made Public' & action3 == 'Registered' & is.na(first_file) ~ 'None',
                                                   action2 == 'Made Public' & action3 == 'Registered' & !is.na(first_file) ~ 'Upload File',
                                                   action2 == 'Registered' & action3 == 'Upload File' & is.na(first_public) ~ 'None',
                                                   action2 == 'Registered' & action3 == 'Upload File' & !is.na(first_public) ~ 'Made Public',
                                                   action2 == 'Registered' & action3 == 'Made Public' & is.na(first_file) ~ 'None',
                                                   action2 == 'Registered' & action3 == 'Made Public' & !is.na(first_file) ~ 'Upload File',
                                                   action3 == 'None' ~ 'None')) %>%
                                  select(action1, action2, action3, action4) %>%
                                  group_by(action1, action2, action3, action4) %>%
                                  tally()

source <- c(0, 0, 0, 0, 3, 3, 3, 2, 2, 2, 4, 4, 4, 7, 7, 7, 6, 6, 6, 8, 8, 8)
target <- c(3, 1, 2, 4, 5, 6, 8, 7, 5, 8, 7, 5, 6, 9, 10, 12, 11, 9, 12, 11, 9, 10)

sankey_data <- rbind(action_flow %>% group_by(action1, action2) %>% summarize(total = sum(n)) %>% rename(from = action1, to = action2),
                      action_flow %>% group_by(action2, action3) %>% summarize(total = sum(n)) %>% rename(from = action2, to = action3),
                      action_flow %>% group_by(action3, action4) %>% summarize(total = sum(n)) %>% rename(from = action3, to = action4)) %>%
              filter(from != 'None') %>%
              add_column(source, target)



p <- plot_ly(
  type = 'sankey',
  orientation = 'h',
  
  node = list(
    label = c("Created Project", "None", "Registered", "Made Public", "Upload File", 'None', "Registered", 'Made Public', "Upload File", "None", "Registered", "Made Public", "Upload File"),
    color = c("blue", "black", "blue", "blue", "blue", "black", "red", "red", "red", "black", "green", "green", "green"),
    pad = 15,
    thickness = 20,
    line = list(
      color = 'black',
      width = .5
    )
  ),
  
  link = list(
    source = sankey_data$source,
    target = sankey_data$target,
    value = sankey_data$total
  )
) %>%
  layout(
    title = 'Non-Deleted, Non-registrations Project Event Flow',
    font = list(
      size = 10
    )
  )
 p

```


## Initial Analyses

The table below shows the number of projects that have each of the actions. These numbers are not mutually exclusive. So, if a project shares a file and has a registration, it will count towards all three totals.

```{r echo = FALSE}
atleast_one_pubnode <- nrow(node_data %>% group_by(root_id) %>% summarize(num_public_nodes = sum(is_public == TRUE)) %>% filter(num_public_nodes > 0))

aggregate_data <- projects_by_product %>%
                    summarize(`Projects with no files or registrations` = sum(has_file == 0 & registered == 0),
                              `Projects with files` = sum(has_file > 0),
                              `Projects sharing > 0 files` = sum(shared_file > 0), 
                              `Projects with > 0 registrations` = sum(registered > 0),
                              `Projects sharing > 0 files and registered` = sum(shared_file > 0 & registered > 0)) %>%
                    gather() %>%
                    mutate(percentage_total_project = round((value/nrow(projects_by_product))*100,2), percentage_public_projects = ifelse(key != 'Projects with > 0 registrations' & key != 'Projects with files' & key != 'Projects with no files or registrations', round((value/atleast_one_pubnode)*100,2), NA))
                                                                                                                          
kable(aggregate_data,
  col.names = c('Project actions', 'Number of top-level projects', 'Percentage of top-level projects', 'Percentage of top-level projects with at least 1 public node')) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
  
sharing_projects <- projects_by_product %>% filter(shared_file == 1) %>% nrow()
registered_projects <- projects_by_product %>% filter(registered == 1) %>% nrow()
sharing_registered <- projects_by_product %>% filter(shared_file ==1 & registered ==1) %>% nrow()

```

The graph shows the number of top-level projects that were created each month that either *only* share files, *only* have a registration, do both of these things, are private and have files but no registration, or do none of these things. So, these numbers are mutually exclusive and will not exactly match the number in the table above, which are not mutually exclusive.

```{r echo = FALSE}

 graph <- ggplot(projects_by_product, aes(pc_by_day, color = products)) + 
  geom_freqpoly(binwidth = 30) +
  xlab('When projects were created') +
  ylab('Number of Top Level Projects') +
  scale_x_date(breaks = date_breaks("3 month"), labels = date_format("%b %y"))
 
 graph + theme(axis.text.x  = element_text(angle=45,hjust = 1,vjust = 1))
 
```

## Days from Project created to last log event:

#### Last log:

```{r echo = FALSE}

## forked projects have logs from original project as well, so will see log dates that happened before project creation date. Moving all those to 0 so only see logs that happened after fork event for forked projects

all_dates <- all_dates %>%
                  mutate(project_to_public = difftime(first_public, project_created, units = 'days'),
                         project_to_reg = difftime(first_reg, project_created, units = 'days'),
                         project_to_lastlog = difftime(last_log, project_created, units = 'days'),
                         project_to_lastcontentadd = difftime(last_contentadd_log, project_created, units = 'days')) %>%
                  mutate(project_to_lastlog = ifelse(project_to_lastlog < 0, 0, project_to_lastlog),
                         project_to_lastcontentadd = ifelse(project_to_lastcontentadd < 0, 0, project_to_lastcontentadd))

```

```{r echo=FALSE}
##time in days from project creation to the last log on the project
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)), aes(project_to_lastlog)) +
  geom_freqpoly(binwidth = 10) +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(0, 2563, by = 365),1)) +
  scale_y_continuous('Numebr of Top Level Projects', breaks = round(seq(0, 150000, by = 5000),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1),aes(project_to_lastlog)) + 
  geom_freqpoly(binwidth = 10) +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects', breaks = round(seq(0, 50000, by = 500),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1),aes(project_to_lastlog, color = products)) + 
  geom_freqpoly(binwidth = 10) +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects', breaks = round(seq(0, 50000, by = 500),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1),aes(project_to_lastlog, color = products)) + 
  geom_density() +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects')


##only projects with a difference more than 1 day - 2016
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1) %>% filter( year == 2016),aes(project_to_lastlog, color = products)) + 
  geom_density() +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects')

##only projects with a difference more than 1 day - 2017
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1) %>% filter( year == 2017),aes(project_to_lastlog, color = products)) + 
  geom_density() +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects')

##only projects with a difference more than 1 day - 2018
ggplot(all_dates %>% filter(!is.na(project_to_lastlog)) %>% filter(project_to_lastlog >= 1) %>% filter( year == 2018),aes(project_to_lastlog, color = products)) + 
  geom_density() +
  ggtitle('Projects with >= 1 day between creation and last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects')
```

#### Last content addition log

```{r echo = FALSE}
##time in days from project creation to the last log on the project
ggplot(all_dates %>% filter(!is.na(project_to_lastcontentadd)), aes(project_to_lastcontentadd)) +
  geom_freqpoly(binwidth = 10) +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(0, 2563, by = 365),1)) +
  scale_y_continuous('Numebr of Top Level Projects', breaks = round(seq(0, 150000, by = 5000),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastcontentadd)) %>% filter(project_to_lastcontentadd >= 1),aes(project_to_lastcontentadd)) + 
  geom_freqpoly(binwidth = 10) +
  ggtitle('Projects with >= 1 day between creation and last content creation log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects', breaks = round(seq(0, 50000, by = 500),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastcontentadd)) %>% filter(project_to_lastcontentadd >= 1),aes(project_to_lastcontentadd, color = products)) + 
  geom_freqpoly(binwidth = 10) +
  ggtitle('Projects with >= 1 day between creation and last content creation log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects', breaks = round(seq(0, 50000, by = 500),1))


##only projects with a difference more than 1 day
ggplot(all_dates %>% filter(!is.na(project_to_lastcontentadd)) %>% filter(project_to_lastcontentadd >= 1),aes(project_to_lastcontentadd, color = products)) + 
  geom_density() +
  ggtitle('Projects with >= 1 day between creation and content creation last log') +
  scale_x_continuous('Days Between Last Log and Date Created',
                     breaks = round(seq(1, 2563, by = 365),1)) +
  scale_y_continuous('Number of Top Level Projects')
```

```{r}
## the basefilenod table is showing incorrect creation dates for files from before

later_project <- all_dates %>%
                    filter(project_created >= '2015-05-01')


first_none <- later_project %>% filter(is.na(first_osf_file_created) & is.na(registration_date) & is.na(last_public)) # number of none projects at first level

file_first <- later_project %>% filter(!is.na(first_osf_file_created) & ((first_osf_file_created < last_public & first_osf_file_created < registration_date) | (first_osf_file_created < last_public & is.na(registration_date)) | (is.na(last_public) & first_osf_file_created < registration_date) | (is.na(last_public) & is.na(registration_date))))

public_first <- later_project %>% filter(!is.na(last_public) & ((last_public < first_osf_file_created & last_public < registration_date) | (last_public < first_osf_file_created & is.na(registration_date)) | (is.na(first_osf_file_created) & last_public < registration_date) | (is.na(first_osf_file_created) & is.na(registration_date))))
  
registered_first <- later_project %>% 
                        filter(!is.na(registration_date) & ((registration_date < last_public & registration_date < first_osf_file_created) | 
                                                              (registration_date < last_public & is.na(first_osf_file_created)) | 
                                                              (is.na(last_public) & registration_date < first_osf_file_created) | 
                                                              (is.na(last_public) & is.na(first_osf_file_created))))


file_then_reg <- file_first %>%
                    filter(!is.na(registration_date) & ((registration_date < last_public) | is.na(last_public)))
                    
file_then_public <- file_first %>%
                      filter(!is.na(last_public) & ((last_public < registration_date) | is.na(registration_date)))
file_then_none <- file_first %>% filter(is.na(last_public) & is.na(registration_date))


public_then_reg <- public_first %>%
                      filter(!is.na(registration_date) & (registration_date < first_osf_file_created | is.na(first_osf_file_created)))
public_then_file <- public_first %>%
                      filter(!is.na(first_osf_file_created) & (first_osf_file_created < registration_date | is.na(registration_date)))
public_then_nothing <- public_first %>% filter(is.na(first_osf_file_created) & is.na(registration_date))

reg_then_public <- registered_first %>%
                      filter(!is.na(last_public) & ((last_public < first_osf_file_created) | is.na(first_osf_file_created)))
reg_then_file <- registered_first %>%
                      filter(!is.na(first_osf_file_created) & ((first_osf_file_created < last_public) | is.na(last_public)))
reg_then_node <- registered_first %>% filter(is.na(last_public) & is.na(first_osf_file_created))


file_reg_public <- file_then_reg %>% filter(!is.na(last_public))
file_reg_none <- file_then_reg %>% filter(is.na(last_public))

file_public_reg <- file_then_public %>% filter(!is.na(registration_date))
file_public_none <- file_then_public %>% filter(is.na(registration_date))


public_reg_file <- public_then_reg %>% filter(!is.na(first_osf_file_created))
public_reg_none <- public_then_reg %>% filter(is.na(first_osf_file_created))

public_file_reg <- public_then_file %>% filter(!is.na(registration_date))
public_file_none <- public_then_file %>% filter(is.na(registration_date))

reg_public_file <- reg_then_public %>% filter(!is.na(first_osf_file_created))
reg_public_none <- reg_then_public %>% filter(is.na(first_osf_file_created))

reg_file_public <- reg_then_file %>% filter(!is.na(last_public))
reg_file_none <- reg_then_file %>% filter(is.na(last_public))

```



```

Potential Next Steps for more complex relationships:

* Are files that are eventually shared being added/modified before or after registrations?
* Add linked projects to the analyses
* How many of the 4817 projects that share files and are registered have contributors in common (i.e. are these projects by a diverse group of people or a smaller set of users who doing this repeatedly across projects)?
* What are the projects with no files in them doing? A lot of them will be empty preprint supplemental nodes, the majority left over from NPD but many newly created supplemental nodes are also left empty. But, not all of them will be supplemental nodes, so what *is* in those projects?
