---
title: "Users_mulitple_osfproducts"
output: html_document
---

This analysis is collecting initial data on the number of users who take advantage of the different products/major classes of sharing behavior on the OSF. The classes of behavior are defined as sharing a file, being on a registration, or being on a preprint. A user does not need to initiate the action themselves to be counted as 'utilizing' the product, they just have to be a contributor on that product. This decision was made because the collaborative nature of OSF projects means that many more researchers take advantage of the existance of a functinoality, such as registratoins, than necessarily do the actions themselves. 

Nodes sharing files is a proxy measure for sharing of data, code, or materials/methods. These are behaviors that are talked about repeatedly in the business plan and are important aspects of TOP, but unfortunately we can't measure this directly yet (we may get closer once filemetadata is implemented, but we'll likely be missing a lot of historical information). So, I've assumed that researchers would mostly be sharing data, materials, and/or code as files within a node, rather than in the wiki, to create a proxy. 

Data caveats and explanations:

 * The data used for the analyses below goes through 4/8/19. 
 * Prepints only include being a contributor on the preprint itself, not just the supplemental node. 
 * Supplemental preprint nodes are include as 'projects' for this analysis.
 * 'Sharing a file' is measured by looking for non-registered nodes that are public and have a file in them. It includes files from OSFstorage and all add-ons

```{sql, eval = FALSE, echo = FALSE}
WITH pp_contrib AS (SELECT user_id, COUNT(preprint_id) AS number_pp, MIN(created) AS first_preprint, MAX(created) AS last_preprint
						FROM osf_preprintcontributor
						LEFT JOIN osf_preprint pp
						ON osf_preprintcontributor.preprint_id = pp.id
						WHERE pp.is_published = 'TRUE' AND (pp.machine_state = 'pending' OR pp.machine_state = 'accepted') AND 
					    pp.is_public = 'TRUE' AND primary_file_id IS NOT NULL AND pp.deleted IS NULL
					    GROUP BY user_id),
	  node_contrib AS (SELECT node_id, user_id, type, osf_abstractnode.created AS node_created, is_public, registered_date, embargo_id, registered_from_id, root_id, date_retracted
	 					FROM osf_contributor
	 					LEFT JOIN osf_abstractnode
						ON osf_contributor.node_id = osf_abstractnode.id
						LEFT JOIN osf_retraction
						ON osf_abstractnode.retraction_id = osf_retraction.id
						WHERE is_deleted IS FALSE AND (spam_status = 4 OR spam_status IS NULL) AND ((type LIKE 'osf.node' AND is_public IS TRUE) OR (type LIKE 'osf.registration' AND date_retracted IS NULL AND (is_public IS TRUE OR 										embargo_id IS NOT NULL)))),
	  existing_files AS (SELECT COUNT(*) AS num_files, target_object_id, MIN(created) AS first_file_created, MAX(created) AS last_file_created
													FROM osf_basefilenode
													WHERE type NOT LIKE '%folder%' AND osf_basefilenode.deleted_on IS NULL AND osf_basefilenode.target_content_type_id = 30
													GROUP BY target_object_id),
		files_on_nodes AS (SELECT node_id, user_id, type, node_created, is_public, registered_date, embargo_id, registered_from_id, root_id, COALESCE(num_files, 0) AS num_files, first_file_created, last_file_created
													FROM node_contrib
													LEFT JOIN existing_files
													ON node_contrib.node_id = existing_files.target_object_id
													WHERE type LIKE 'osf.registration' OR (type LIKE 'osf.node' AND num_files > 0)),		
						
		eligible_node_contribs AS (SELECT user_id, COUNT(DISTINCT root_id) FILTER (WHERE type LIKE 'osf.node') AS eligible_nodes, COUNT(DISTINCT root_id) FILTER (WHERE type LIKE 'osf.registration') AS eligible_regs, 
																			MIN(node_created) FILTER (WHERE type LIKE 'osf.node') AS first_node, MAX(node_created) FILTER (WHERE type LIKE 'osf.node') AS last_node,
																			MIN(registered_date) FILTER (WHERE type LIKE 'osf.registration') AS first_registration, MAX(registered_date) FILTER (WHERE type LIKE 'osf.registration') AS last_registration		 															FROM files_on_nodes
																	GROUP BY user_id),
	all_contribs AS (SELECT COALESCE(eligible_node_contribs.user_id, pp_contrib.user_id) AS user_id, COALESCE(eligible_nodes, 0) AS number_nodes, COALESCE(eligible_regs, 0) AS number_regs, first_node, last_node, first_registration, 														last_registration, COALESCE(number_pp, 0) AS number_pp, first_preprint,last_preprint
												FROM eligible_node_contribs
												FULL OUTER JOIN pp_contrib
												ON eligible_node_contribs.user_id = pp_contrib.user_id)

SELECT * 
	FROM all_contribs
	LEFT JOIN osf_osfuser
	ON all_contribs.user_id = osf_osfuser.id;
```

```{r warning=FALSE, echo=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(scales)
library(knitr)
library(kableExtra)


knitr::opts_chunk$set(fig.width=12, fig.height=8) 

user_data <- read_csv('/Users/courtneysoderberg/Downloads/User_activity.csv', col_types = cols(merged_by_id = col_character()))
```
## Initial Analyses

The table below shows the raw number and percentage of active users who are contributors on the 3 different 'products' and all possible combinations of them. These are not mutually exclusive numbers. For example, 'Registration' includes everyone who is a contributor on at least one registration, not only users who are contributors on registrations but not on a preprint or a non-registration node that shares a file.

```{r}
user_categorization <- user_data %>%
                          mutate(preprint_creator = case_when(num_preprints > 0 ~ 1,
                                                              TRUE ~ 0),
                                 preprint_contributor = case_when(num_pp_visible_contrib + num_pp_visible_contrib > 0 ~ 1,
                                                                  TRUE ~ 0),
                                 preprint_user = case_when(preprint_creator == 1 | preprint_contributor == 1 ~ 1,
                                                           TRUE ~ 0),
                                 suppnode_creator = case_when(num_suppnode > 0 ~ 1,
                                                              TRUE ~ 0),
                                 suppnode_contributor = case_when(num_suppnode_contrib > 0 ~ 1,
                                                                  TRUE ~ 0),
                                 suppnode_user = case_when(num_suppnode > 0 | num_suppnode_contrib > 0 ~ 1,
                                                           TRUE ~ 0),
                                 osf4m_creator = case_when(num_osf4m > 0 ~ 1,
                                                          TRUE ~ 0),
                                 osf4m_contributor = case_when(num_osf4m_contrib > 0 ~ 1,
                                                              TRUE ~ 0),
                                 osf4m_user = case_when(num_osf4m > 0 | num_osf4m_contrib > 0 ~ 1,
                                                        TRUE ~ 0),
                                 registrations_creator = case_when(num_toplevel_regs > 0 ~ 1,
                                                                   TRUE ~ 0),
                                 registrations_contributor = case_when(num_regnodes_contrib > 0 ~ 1,
                                                                       TRUE ~ 0),
                                 registrations_user = case_when(num_toplevel_regs > 0 | num_regnodes_contrib > 0 ~ 1,
                                                                TRUE ~ 0),
                                 osf_projects_creator = case_when(num_toplevel_projects > 0 ~ 1,
                                                                  TRUE ~ 0),
                                 osf_projects_contributor = case_when(num_nodes_contrib > 0 ~ 1,
                                                                      TRUE ~ 0),
                                 osf_projects_user = case_when(num_toplevel_projects > 0 | num_nodes_contrib > 0 ~ 1,
                                                               TRUE ~ 0),
                                 public_sharing_creator = case_when(num_publicfiles_nodes > 0 ~ 1,
                                                                    TRUE ~ 0),
                                 public_sharing_contributor = case_when(num_publicfiles_nodes_contrib > 0 ~ 1,
                                                                        TRUE ~ 0),
                                 public_sharing_user = case_when(num_publicfiles_nodes > 0 | num_publicfiles_nodes_contrib > 0 ~ 1,
                                                                 TRUE ~ 0),
                                 private_storage_creator = case_when(num_privatefiles_nodes > 0 ~ 1,
                                                                     TRUE ~ 0),
                                 private_storage_contributor = case_when(num_privatefiles_nodes_contrib > 0 ~ 1,
                                                                           TRUE ~ 0),
                                 private_storage_user = case_when(num_privatefiles_nodes > 0 | num_privatefiles_nodes_contrib > 0 ~ 1,
                                                                  TRUE ~ 0),
                                 user_origin = case_when(grepl('preprint', user_tag) ~ 'preprints',
                                                         grepl('osf4m', user_tag) ~ 'meetings',
                                                         grepl('challenge', user_tag) | grepl('registries', user_tag) ~ 'registries',
                                                         is_invited == TRUE ~ 'unknown',
                                                         is_invited == FALSE ~ 'OSF'),
                                 power_user = case_when(num_toplevel_regs + num_toplevel_projects >= 10 ~ 1,
                                                        TRUE ~ 0))
```


```{r echo=FALSE}
data <- data %>%
           mutate(by_day_confirmed = as_date(date_confirmed)) %>%
           mutate(by_day_registered = as_date(date_registered)) %>%
           mutate(action_types = case_when(number_public_file_nodes == 0 & number_regs == 0 & number_pp == 0 & number_private_file_nodes == 0 ~ 'No products',
                                           number_public_file_nodes == 0 & number_regs == 0 & number_pp == 0 & number_private_file_nodes > 0 ~ 'Only private file nodes',
                                           number_public_file_nodes > 0 & number_regs == 0 & number_pp == 0 ~ 'Only projects',
                                           number_public_file_nodes == 0 & number_regs > 0 & number_pp == 0 ~ 'Only regs',
                                           number_public_file_nodes == 0 & number_regs == 0 & number_pp > 0 ~ 'Only preprints',
                                           number_public_file_nodes > 0 & number_regs > 0 & number_pp == 0 ~ 'Projects & regs',
                                           number_public_file_nodes > 0 & number_regs == 0 & number_pp > 0 ~ 'Projects & preprints',
                                           number_public_file_nodes == 0 & number_regs > 0 & number_pp > 0 ~ 'Regs & preprints',
                                           number_public_file_nodes > 0 & number_regs > 0 & number_pp > 0 ~ 'All products'))

aggregate_numbers <- data %>% filter(is_active == 'TRUE') %>% 
                        summarize(on_none = sum(number_public_file_nodes == 0 & number_regs == 0 & number_pp == 0 & number_private_file_nodes == 0),
                                  on_private_file_project = sum(number_private_file_nodes > 0 & number_public_file_nodes == 0),
                                  on_sharing_project = sum(number_public_file_nodes > 0), 
                                  on_registrations = sum(number_regs > 0), 
                                  on_preprint = sum(number_pp > 0), 
                                  on_sharingproject_regs = sum(number_regs > 0 & number_public_file_nodes > 0), 
                                  on_sharingproject_pp = sum(number_public_file_nodes > 0 & number_pp > 0), 
                                  on_regs_pp = sum(number_regs > 0 & number_pp > 0), 
                                  on_sharingproject_reg_preprint = sum(number_public_file_nodes>0 & number_regs > 0 & number_pp > 0))

table_data <- gather(aggregate_numbers) %>% 
                  mutate(percentages = round((value / 142931) * 100,2)) %>%
                  mutate(key = case_when(grepl('on_none', key) ~ 'On none of the product types',
                                         grepl('on_private_file_project', key) ~ 'Only Private nodes with files',
                                         grepl('on_sharing_project', key) ~ 'Nodes sharing > 0 files',
                                         grepl('on_registrations',key) ~ 'Registration',
                                         grepl('on_preprint',key) ~ 'Preprints',
                                         grepl('on_sharingproject_regs',key) ~ 'Public sharing nodes and a regisration',
                                         grepl('on_sharingproject_pp',key) ~ 'Public sharing nodes and a preprint',
                                         grepl('on_regs_pp',key) ~ 'Registration and a preprint',
                                         grepl('on_sharingproject_reg_preprint',key) ~ 'All three'))

kable(table_data,
      col.names = c('Metric','Number of Active Users','Percentage of Active Users'),
      caption = 'Active Users who are contributors on different products') %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

The graphs below shows when the different types of users were confirmed. For the second graph, these show mutually exclusive categories of users. So, 'only preprints' are users who are contributors on preprints, but not registrations or non-registration nodes that share files. 

```{r echo = FALSE}

 graph <- ggplot(data %>% filter(number_public_file_nodes >0 & number_regs > 0 & number_pp > 0) %>% filter(is_active == 'TRUE'), aes(by_day_confirmed)) + 
  geom_freqpoly(binwidth = 30) +
  xlab('When user was confirmed') +
  ylab('Number of users') +
  labs(title = 'Users who are contributors on all 3 types') +
  scale_x_date(breaks = date_breaks("3 month"), labels = date_format("%b %y"))
 
 graph + theme(axis.text.x  = element_text(angle=45,hjust = 1,vjust = 1))
 

 graph2 <- ggplot(data %>% filter(is_active == 'TRUE') %>% filter(action_types != 'Only private file nodes'), aes(by_day_confirmed, color = action_types)) + 
  geom_freqpoly(binwidth = 30) +
  xlab('When user was confirmed') +
  ylab('Number of users') +
  scale_x_date(breaks = date_breaks("3 month"), labels = date_format("%b %y"))
 
 graph2 + theme(axis.text.x  = element_text(angle=45,hjust = 1,vjust = 1))
 
```


## What are the 'none' users doing?

```{sql, eval = FALSE, echo = FALSE}
/* counts of logs for each user grouped by log action */
SELECT action, user_id, COUNT(id)
							FROM osf_nodelog
							GROUP BY user_id, action;
							
/* counts of preprintlogs for each user grouped by log action */							
SELECT action, user_id, COUNT(id) AS number_preprint_logs
							FROM osf_preprintlog
							GROUP BY user_id, action;
							
/* all the project and registration nodes each user is a contributor on, excluding bookmarks */							
SELECT osf_contributor.node_id, osf_contributor.user_id, root_id, is_deleted, is_public, is_fork, spam_status, created, modified, type, deleted_date, title, embargo_id, retraction_id, registered_from_id
	FROM osf_contributor
	LEFT JOIN osf_abstractnode
	ON osf_contributor.node_id = osf_abstractnode.id
	WHERE (type LIKE 'osf.node' OR type LIKE 'osf.registration') AND title NOT LIKE 'Bookmarks';
```

```{r warning=FALSE, echo=FALSE, message=FALSE}
user_node_logs <- read_csv('/Users/courtneysoderberg/Downloads/user_logs.csv')

user_preprint_logs <- read_csv('/Users/courtneysoderberg/Downloads/preprint_logs.csv')

contributor_nodes <- read_csv('/Users/courtneysoderberg/Downloads/contributor_nodes.csv')

user_logs <- rbind(user_node_logs, user_preprint_logs)
```

```{r echo=FALSE}
logs_no_product_users <- data %>% 
                            filter(action_types == 'No products') %>%
                            filter(is_active == 'TRUE') %>%
                            left_join(user_logs, by = 'user_id') %>%
                            mutate(count = replace_na(count, 0))

logs_per_user <- logs_no_product_users %>%
                    group_by(user_id) %>%
                    summarize(total_logs = sum(count))

Mode <- function(x) {
   ux <- unique(x)
   ux[which.max(tabulate(match(x, ux)))]
}

nodes_no_product_users <- data %>%
                            filter(action_types == 'No products') %>%
                            filter(is_active == 'TRUE') %>%
                            left_join(contributor_nodes, by = 'user_id')

nodes_per_user <- nodes_no_product_users %>% 
                      group_by(user_id) %>% 
                      summarise(total_nodes = sum(!is.na(node_id)),
                                total_nondeleted_nodes = sum(!is.na(node_id) & is_deleted == 'FALSE'))
            
```

#### Quickfiles?
The number of these users who have uploaded quickfiles is: `r data %>% filter(action_types == 'No products') %>% summarize(quickfiles = sum(quickfile_node > 0))`

#### Logs?

When all users were given a 'Bookmarks' node, this created a log for all users. Bookmark nodes are excluded from the node analysis, but the log action is 'created_project' so not unique. So, many users have 1 log because of there automatically generate bookmark node. 


The number of users with 1 or fewer logs is: `r sum(logs_per_user$total_logs <= 1)`

* The mean number of logs is: `r round(mean(logs_per_user$total_logs),2)` 
* The mediam number of logs is: `r median(logs_per_user$total_logs)` 
* The modal number of logs is: `r Mode(logs_per_user$total_logs)`


#### Nodes (registrations or project nodes)?

The number of users on no nodes is: `r sum(nodes_per_user$total_nodes == 0)`
The number of users on no *non-deleted nodes* is: `r sum(nodes_per_user$total_nondeleted_nodes == 0)`

* The mean number of nodes is: `r round(mean(nodes_per_user$total_nodes),2)` 
* The mediam number of nodes is: `r median(nodes_per_user$total_nodes)` 
* The modal number of nodes is: `r Mode(nodes_per_user$total_nodes)`

* The mean number of *non-deleted* nodes is: `r round(mean(nodes_per_user$total_nondeleted_nodes),2)` 
* The mediam number of *non-deleted* nodes is: `r median(nodes_per_user$total_nondeleted_nodes)` 
* The modal number of *non-deleted* nodes is: `r Mode(nodes_per_user$total_nondeleted_nodes)`

```{r echo = FALSE}
logs_and_nodes <- full_join(logs_per_user, nodes_per_user, by = 'user_id')

```

#### No nodes and less than 2 logs (see bookmark node above)?

The number of active users with no logs and who are not contributors on any nodes or registrations is: `r sum(logs_and_nodes$total_logs <= 1 & logs_and_nodes$total_nodes == 0)`

The number of active users with no logs and who are not contributors on any *non-deleted* nodes or registrations is: `r sum(logs_and_nodes$total_logs <= 1 & logs_and_nodes$total_nondeleted_nodes == 0)`

## Potential Next Steps for more complex relationships:

* What is the timecourse of the actions (e.g. for researchers who are on sharing projects and registrations, which tended to happen first and how long in between the actions)
* Are the users in the different 'action_type' groups from particular disciplines? (infered from OSF4M and preprint services until we have better disciplinary information)
